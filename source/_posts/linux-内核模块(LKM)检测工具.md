title: linux 内核模块(LKM)检测工具
categories: [网络安全]
tags: []
date: 2011-12-29 11:26:00
---
在生产环境中，系统被入侵后，黑客会放置自己的后门。LKM后门和传统的后门不一样，它可以通过隐藏进程、端口、文件的方式隐藏自己，不被管理员轻易发现，也就是常说的rootkit技术。<br />LKM是什么？load kernel module，可加载内核模块的缩写。<br />xlkm一个脚本，通过对准上线机器现加载内核模块进行备份，来判别模块是否替换、篡改。<br />主要思路就是：列出系统加载的内核模块并备份，对现加载的模块的md5校验并备份其信息，然后进行对比。<br /><p>实现起来比较简单，我shell也不是很好，大家就凑活着看吧。</p><p>&nbsp;</p><p></p><p>#!/bin/bash</p><p>&nbsp;</p><p>#code:key1088</p><p>#mail:key1088@163.com</p><p>#bash --version</p><p>#GNU bash, version 3.2.25(1)-release (i686-redhat-linux-gnu)</p><p>#Copyright (C) 2005 Free Software Foundation, Inc</p><p>&nbsp;</p><p>if [ $(whoami) != &quot;root&quot; ];</p><p>then</p><p>echo &quot;Not root&quot;</p><p>exit 0</p><p>fi</p><p>&nbsp;</p><p>xlkmroot=/usr/local/xlkm</p><p>&nbsp;</p><p>help(){</p><p>echo -e &quot; 33[32m List:&quot;</p><p>echo &quot;[1.Start LKM List Backup]&quot;</p><p>echo &quot;[2.Test LKM List Change]&quot;</p><p>echo &quot;[3.Delete All Backup]&quot;</p><p>echo &quot;[4.Quit]&quot;</p><p>echo -e &quot; 33[0m&quot;</p><p>}</p><p>&nbsp;</p><p>SETUPXLKM(){</p><p>if test -d $xlkmroot ;then</p><p>echo &quot;LKM exist Backup!!&quot;</p><p>exit 1</p><p>fi</p><p>mkdir $xlkmroot</p><p>chmod 700 $xlkmroot</p><p>}</p><p>&nbsp;</p><p>DELXLKM(){</p><p>rm -rf $xlkmroot</p><p>echo</p><p>echo -e &quot; 33[34mDelete XLKM Backup Sccessfully 33[0m&quot;</p><p>echo</p><p>}</p><p>&nbsp;</p><p>START(){</p><p>while [ -z $passwd ]</p><p>do</p><p>echo</p><p>echo -n &quot;Input encrypt passwd[No Null]:&quot;</p><p>read passwd</p><p>done</p><p>echo &quot;WAITing.....&quot;</p><p>lsmod &gt; $xlkmroot/lkmlist.main</p><p>for i in $(modprobe -l)</p><p>do</p><p>md5sum $i &gt;&gt; $xlkmroot/lkmfile.md5.main</p><p>done</p><p>cd $xlkmroot</p><p>zip -P $passwd mainfile.zip ./*.main &gt; /dev/null</p><p>rc=$?</p><p>if [ &quot;$rc&quot; == 0 ];</p><p>then</p><p>echo</p><p>echo -e &quot; 33[34mLKM List Backup Successfully! 33[0m&quot;</p><p>echo&nbsp;</p><p>else</p><p>echo</p><p>echo -e &quot; 33[34mBeijule! Error! 33[0m&quot;</p><p>echo&nbsp;</p><p>fi</p><p>rm -f $xlkmroot/lkm* &gt; /dev/null</p><p>}</p><p>&nbsp;</p><p>LKMCHANGE(){</p><p>echo &quot;Test LKM Change&quot;</p><p>&nbsp;</p><p>cd $xlkmroot</p><p>while [ &quot;$ra&quot; != 0 ]</p><p>do</p><p>echo</p><p>echo -n &quot;Input encrypt passwd[No Null]:&quot;</p><p>read passwd</p><p>unzip -P $passwd mainfile.zip &gt; /dev/null 2&gt;&amp;1</p><p>ra=$?</p><p>if [ &quot;$ra&quot; != 0 ];then echo &quot;Invalid password!! &quot;; fi</p><p>done</p><p>echo &quot;WAITing.....&quot;</p><p>lsmod &gt; $xlkmroot/lkmlist.new</p><p>for i in $(modprobe -l)</p><p>do</p><p>md5sum $i &gt;&gt; $xlkmroot/lkmfile.md5.new</p><p>done</p><p>echo &quot;LKM List Change:&quot;</p><p>echo -e &quot; 33[31m&quot;</p><p>diff $xlkmroot/lkmlist.main $xlkmroot/lkmlist.new</p><p>echo -e &quot; 33[0m&quot;</p><p>echo &quot;LKM File Md5 Change:&quot;</p><p>echo -e &quot; 33[31m&quot;</p><p>diff $xlkmroot/lkmfile.md5.main $xlkmroot/lkmfile.md5.new</p><p>echo -e &quot; 33[0m&quot;</p><p>rm -f *.new *.main</p><p>&nbsp;</p><p>}</p><p>&nbsp;</p><p>while :</p><p>do</p><p>&nbsp;</p><p>help</p><p>echo -n &quot;Input List num:&quot;</p><p>read x</p><p>&nbsp;</p><p>case &quot;$x&quot; in</p><p>1)</p><p>SETUPXLKM</p><p>START</p><p>;;</p><p>2)</p><p>LKMCHANGE</p><p>;;</p><p>3)</p><p>DELXLKM</p><p>;;</p><p>4)</p><p>exit 0</p><p>;;</p><p>*)</p><p>echo -e &quot; 33[31mError !!!!!&quot;</p><p>echo -e &quot;Pleae input [1-4] list option  33[0m&quot;</p><p>;;</p><p>esac</p><p>&nbsp;</p><p>done</p><p>&nbsp;</p><em></em><p></p>