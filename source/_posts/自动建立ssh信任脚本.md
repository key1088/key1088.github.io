title: 自动建立ssh信任脚本
categories: [Linux,Shell编程]
tags: []
date: 2011-12-01 10:22:00
---
<p>转自：www.chinaunix.net。作者：老表</p><p>&nbsp;</p><p>在工作中经常遇到给两台主机建立ssh信任，手动建立太费事了，索性胡乱写了个脚本ssh_trust.sh来自动建立信任：</p><ol><li>#!/bin/bash<br /></li><li>src_host=$1<br /></li><li>src_username=$2<br /></li><li>src_passwd=$3<br /></li><li><br /></li><li>dst_host=$4<br /></li><li>dst_username=$5<br /></li><li>dst_passwd=$6<br /></li><li><br /></li><li>#在远程主机1上生成公私钥对<br /></li><li>Keygen()<br /></li><li>{<br /></li><li>expect &lt;&lt; EOF<br /></li><li><br /></li><li>spawn ssh $src_username@$src_host ssh-keygen -t rsa<br /></li><li>while 1 {<br /></li><li><br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;expect {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&quot;password:&quot; {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; send &quot;$src_passwdn&quot;<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;}<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&quot;yes/no*&quot; {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; send &quot;yesn&quot;<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;}<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&quot;Enter file in which to save the key*&quot; {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; send &quot;n&quot;<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;}<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&quot;Enter passphrase*&quot; {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; send &quot;n&quot;<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;}<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&quot;Enter same passphrase again:&quot; {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; send &quot;n&quot;<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; }<br /></li><li><br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&quot;Overwrite (y/n)&quot; {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; send &quot;nn&quot;<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;}<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;eof {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;exit<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;}<br /></li><li><br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;}<br /></li><li>}<br /></li><li>EOF<br /></li><li>}<br /></li><li><br /></li><li>#从远程主机1获取公钥保存到本地<br /></li><li>Get_pub()<br /></li><li>{<br /></li><li>expect &lt;&lt; EOF<br /></li><li><br /></li><li>spawn scp $src_username@$src_host:~/.ssh/id_rsa.pub /tmp<br /></li><li>expect {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; &quot;password:&quot; {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; send &quot;$src_passwdn&quot;;exp_continue<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; }<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; &quot;yes/no*&quot; {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; send &quot;yesn&quot;;exp_continue<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; }&nbsp; &nbsp;<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; eof {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;exit<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; }<br /></li><li>}<br /></li><li>EOF<br /></li><li>}<br /></li><li>#将公钥的内容附加到远程主机2的authorized_keys<br /></li><li>Put_pub()<br /></li><li>{<br /></li><li>src_pub=&quot;$(cat /tmp/id_rsa.pub)&quot;<br /></li><li>expect &lt;&lt; EOF<br /></li><li>spawn ssh $dst_username@$dst_host &quot;chmod 700 ~/.ssh;echo $src_pub &gt;&gt; ~/.ssh/authorized_keys;chmod 600 ~/.ssh/authorized_ke<br /></li><li>ys&quot;<br /></li><li>expect {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&quot;password:&quot; {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;send &quot;$dst_passwdn&quot;;exp_continue<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; }<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&quot;yes/no*&quot; {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;send &quot;yesn&quot;;exp_continue<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; }&nbsp; &nbsp;<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;eof {<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;exit<br /></li><li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; } <br /></li><li>}<br /></li><li>EOF<br /></li><li>}<br /></li><li>Keygen<br /></li><li>Get_pub<br /></li><li>Put_pub</li></ol><em></em>脚本主要由3个expect组成，比较简单，用法是<ol><li>./ssh_trust.sh host1 user1 passwd1 host2 user2 passwd2</li></ol><em></em>即建立从user1@host1到user2@host2的ssh信任。<br />说明：<br />1、当然得安装expect<br />2、脚本放在第三方机器（能远程登录host1和host2）上运行即可，当然放在host1和host2上运行也行。<br />3、如果想批量建立信任，可以编辑一个文件夹file如：<ol><li>host1 user1 passwd1 host2 user2 passwd2<br /></li><li>host3 user3 passwd3 host4 user4 passwd4<br /></li><li>host5 user5 passwd5 host6 user6 passwd6</li></ol><em></em>使用下面命令执行脚本即可：<ol><li>xargs -n6 ./ssh_trust.sh &lt; file</li></ol><em></em>4、仓促写的，脚本只是简单实现功能，使用前确保参数的可用性（用户密码主机名），不然很容易报错<br />5、只在linuxredhat上测试过，运行成功，欢迎大家提意见~~